{% extends "dashboard/dashboard.html" %}
{% block dash %}
<div class="m-3">
   
  <div class="bg-gradient-to-r from-indigo-50 via-white to-indigo-50 min-h-screen flex items-center justify-center p-6">
    <div class="bg-white shadow-xl rounded-lg max-w-4xl w-full mx-auto p-10 md:p-14 lg:p-20">
      {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        <div
          class="p-3 rounded-md text-white font-semibold
          {% if message.tags == 'success' %} bg-green-600
          {% elif message.tags == 'error' %} bg-red-600
          {% else %} bg-indigo-600
          {% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

      <!-- Title & Submitted info -->
      <header class="mb-8">
        <h1 class="text-4xl font-extrabold text-gray-900 leading-tight">{{ complain.title }}</h1>
        <p class="text-gray-600 mt-2">
          Submitted by <span class="font-semibold text-indigo-700">{{ complain.user.get_full_name|default:"Not give name" }}</span>
          on <time datetime="{{ complain.submitted_at|date:"c" }}" class="italic">{{ complain.submitted_at|date:"F j, Y" }}</time>
        </p>
      </header>

      <!-- Description -->
      <section class="mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Description</h2>
        <p class="text-gray-700 leading-relaxed text-lg">{{ complain.description }}</p>
      </section>

      <!-- Image (if exists) -->
      {% if complain.image %}
      <section class="mb-8">
        <img src="{{ complain.image.url }}" alt="Complaint Image"
          class="rounded-lg shadow-lg w-full max-h-[480px] object-cover mx-auto" />
      </section>
      {% endif %}

      <!-- Status & Tags -->
      <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
        <div>
          {% if request.user.is_staff %}
          <form method="POST" action="{% url 'complain_detail' complain.id %}">
            {% csrf_token %}
            <label for="status" class="block mb-2 text-gray-700 font-semibold">Status</label>
            <select name="status" id="status"
              onchange="this.form.submit()"
              class="w-full md:w-64 rounded-md border border-indigo-300 bg-indigo-50 text-indigo-900 font-semibold py-2 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-400">
              <option value="pending" {% if complain.status == 'pending' %}selected{% endif %}>Pending</option>
              <option value="resolved" {% if complain.status == 'resolved' %}selected{% endif %}>Resolved</option>
              <option value="rejected" {% if complain.status == 'rejected' %}selected{% endif %}>Rejected</option>
            </select>
          </form>
          {% else %}
              <label for="status" class="block mb-2 text-gray-700 font-semibold">Status</label>
              <p class=" text-indigo-800 text-sm font-medium rounded-full px-4 py-1 shadow-sm">{{ complain.status|title }}</p>
          {% endif %}
        </div>

        <div>
          <label class="block mb-2 text-gray-700 font-semibold">Tags</label>
          <div class="flex flex-wrap gap-3">
            {% for tag in complain.tags.all %}
              <span
                class="bg-indigo-100 text-indigo-800 text-sm font-medium rounded-full px-4 py-1 shadow-sm">{{ tag.name }}</span>
            {% empty %}
              <span class="text-gray-500 italic">No tags assigned</span>
            {% endfor %}
          </div>
        </div>
      </section>
        
      <h3 class="text-2xl font-semibold text-gray-800 mb-4">Responses for this Complain:</h3>

<div class="space-y-4">
    {% for response in complain.responses.all %}
    <div class="bg-white shadow-md rounded-xl p-4 flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-4 border border-gray-200 hover:shadow-lg transition">
        <!-- Responder Avatar (optional) -->
        <div class="flex-shrink-0">
            <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-lg">
                {{ response.responder.username|slice:":1"|upper }}
            </div>
        </div>

        <!-- Message Content -->
        <div class="flex-1">
            <p class="text-gray-700">{{ response.message }}</p>
            <p class="text-sm text-gray-500 mt-1">By: <span class="font-medium">{{ response.responder.username }}</span></p>
        </div>

        <!-- Timestamp (optional) -->
        <div class="text-xs text-gray-400 mt-2 md:mt-0">
            {{ response.complain.submitted_at|date:"M d, Y" }}
        </div>
    </div>
    {% empty %}
    <p class="text-gray-500 italic">No responses yet.</p>
    {% endfor %}
</div>



      {% if request.user.is_staff %}
        <a href="{% url 'give_response' complain.id %}"
        class="inline-block mt-6 text-indigo-600 hover:text-indigo-800 hover:underline font-semibold transition-colors duration-200">
          Give Response
        </a>
      {% endif %}

      {% if request.user.id == complain.user.id %}
    {% if complain.responses.count == 0 %}
        <!-- User is owner AND no responses -->
        <a href="{% url 'update_complain' complain.id %}"
           class="inline-block mt-6 text-indigo-600 hover:text-indigo-800 hover:underline font-semibold transition-colors duration-200">
           Update Complaints
        </a>
    {% else %}
        <!-- User is owner BUT there are responses, disable link -->
        <span class="inline-block mt-6 text-gray-400 cursor-not-allowed font-semibold">
            Update Complaints
        </span>
    {% endif %}
{% endif %}


    </div>
  </div>
</div>
{% endblock dash %}
